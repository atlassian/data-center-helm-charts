{{- if or .Values.atlassianAnalyticsAndSupport.analytics.enabled .Values.atlassianAnalyticsAndSupport.helmValues.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "common.names.fullname" . }}-helm-values
  labels:
    {{- include "common.labels.commonLabels" . | nindent 4 }}
data:
{{- if .Values.atlassianAnalyticsAndSupport.helmValues.enabled }}
  values.yaml: |
  {{- include "crowd.sanitizedValues" . }}
{{- end }}
{{- if .Values.atlassianAnalyticsAndSupport.analytics.enabled }}
  analytics.json: |
    {
      "imageTag": {{ if or (eq .Values.image.tag "") (eq .Values.image.tag nil) }}{{ .Chart.AppVersion | quote }}{{ else }}{{ .Values.image.tag | quote }}{{ end }},
      "replicas": {{ .Values.replicaCount }},
      "isJmxEnabled": {{ .Values.monitoring.exposeJmxMetrics }},
      "isIngressEnabled": {{ .Values.ingress.create }},
      "k8sVersion": "{{ .Capabilities.KubeVersion }}",
      "svcType": {{ if regexMatch "^(ClusterIP|NodePort|LoadBalancer|ExternalName)$" .Values.crowd.service.type }}{{ .Values.crowd.service.type | quote }}{{ else }}"unknown"{{ end }},
{{- if eq .Values.database.type nil }}
      "dbType": "unknown"
{{- else }}
{{- $databaseTypeMap := dict "postgres" "postgres" "mssql" "mssql" "oracle" "oracle" "mysql" "mysql" }}
{{- $dbTypeInValues := .Values.database.type }}
  {{- $dbType := "unknown" | quote }}
  {{- range $key, $value := $databaseTypeMap }}
    {{- if regexMatch $key $dbTypeInValues }}
      {{- $dbType = $value | quote }}
    {{- end }}
  {{- end }}
      "dbType": {{ $dbType }}
{{- end }}
    }
{{- end }}
{{- end }}
