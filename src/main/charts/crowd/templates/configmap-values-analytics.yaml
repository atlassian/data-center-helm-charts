{{- if or .Values.atlassianAnalyticsAndSupport.analytics.enabled .Values.atlassianAnalyticsAndSupport.helmValues.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "common.names.fullname" . }}-helm-values
  labels:
    {{- include "common.labels.commonLabels" . | nindent 4 }}
data:
{{- if .Values.atlassianAnalyticsAndSupport.helmValues.enabled }}
  values.yaml: |
  {{- include "crowd.sanitizedValues" . }}
{{- end }}
{{- if .Values.atlassianAnalyticsAndSupport.analytics.enabled }}
  analytics.json: |
    {
      "imageTag": {{ if or (eq .Values.image.tag "") (eq .Values.image.tag nil) }}{{ .Chart.AppVersion | quote }}{{ else }}{{ .Values.image.tag | quote }}{{ end }},
      "replicas": {{ .Values.replicaCount }},
      "isJmxEnabled": {{ .Values.monitoring.exposeJmxMetrics }},
      "isIngressEnabled": {{ .Values.ingress.create }},
{{- if .Values.ingress.create }}
      "isIngressNginx": {{ .Values.ingress.nginx }},
{{- end }}
{{- $sanitizedMinorVersion := regexReplaceAll "[^0-9]" .Capabilities.KubeVersion.Minor "" }}
      "k8sVersion": "{{ .Capabilities.KubeVersion.Major }}.{{ $sanitizedMinorVersion }}",
      "svcType": {{ if regexMatch "^(ClusterIP|NodePort|LoadBalancer|ExternalName)$" .Values.crowd.service.type }}{{ .Values.crowd.service.type | quote }}{{ else }}"unknown"{{ end }},
      "dbType": "unknown",
      "isSharedHomePVCCreated": {{ .Values.volumes.sharedHome.persistentVolumeClaim.create }},
      "isServiceMonitorCreated": {{ .Values.monitoring.serviceMonitor.create }},
      "isGrafanaDashboardsCreated": {{ .Values.monitoring.grafana.createDashboards }}
    }
{{- end }}
{{- end }}
