{{- if or .Values.atlassianAnalyticsAndSupport.analytics.enabled .Values.atlassianAnalyticsAndSupport.helmValues.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "common.names.fullname" . }}-helm-values
  labels:
    {{- include "common.labels.commonLabels" . | nindent 4 }}
data:
{{- if .Values.atlassianAnalyticsAndSupport.helmValues.enabled }}
  values.yaml: |
  {{- include "jira.sanitizedValues" . }}
{{- end }}
{{- if .Values.atlassianAnalyticsAndSupport.analytics.enabled }}
  analytics.json: |
    {
      "imageTag": {{ if or (eq .Values.image.tag "") (eq .Values.image.tag nil) }}{{ .Chart.AppVersion | quote }}{{ else }}{{ .Values.image.tag | quote }}{{ end }},
      "replicas": {{ .Values.replicaCount }},
      "isJmxEnabled": {{ .Values.monitoring.exposeJmxMetrics }},
      "isIngressEnabled": {{ .Values.ingress.create }},
{{- if .Values.ingress.create }}
      "isIngressNginx": {{ .Values.ingress.nginx }},
{{- end }}
{{- $sanitizedMinorVersion := regexReplaceAll "[^0-9]" .Capabilities.KubeVersion.Minor "" }}
      "k8sVersion": "{{ .Capabilities.KubeVersion.Major }}.{{ $sanitizedMinorVersion }}",
      "isS3AvatarsEnabled": {{ if and .Values.jira.s3Storage.avatars.bucketName .Values.jira.s3Storage.avatars.bucketRegion }}true{{ else }}false{{ end }},
      "svcType": {{ if regexMatch "^(ClusterIP|NodePort|LoadBalancer|ExternalName)$" .Values.jira.service.type }}{{ .Values.jira.service.type | quote }}{{ else }}"unknown"{{ end }},
{{- if eq .Values.database.type nil }}
      "dbType": "unknown",
{{- else }}
{{- $databaseTypeMap := dict "postgres" "postgres" "mssql" "mssql" "sqlserver" "sqlserver" "oracle" "oracle" "mysql" "mysql" }}
{{- $dbTypeInValues := .Values.database.type }}
  {{- $dbType := "unknown" | quote }}
  {{- range $key, $value := $databaseTypeMap }}
    {{- if regexMatch (printf "(?i)%s" $key) $dbTypeInValues }}
      {{- $dbType = $value | quote }}
    {{- end }}
  {{- end }}
      "dbType": {{ $dbType }},
{{- end }}
      "isClusteringEnabled": {{ .Values.jira.clustering.enabled }},
      "isSharedHomePVCCreated": {{ .Values.volumes.sharedHome.persistentVolumeClaim.create }},
      "isServiceMonitorCreated": {{ .Values.monitoring.serviceMonitor.create }},
      "isGrafanaDashboardsCreated": {{ .Values.monitoring.grafana.createDashboards }}
    }
{{- end }}
{{- end }}
